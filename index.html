<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Palm Oil Mills Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; }
        #map { height: 100vh; width: 100%; }
        #sidebar {
            position: fixed;
            top: 70px;
            right: 0;
            width: 300px;
            height: calc(100vh - 70px);
            background: white;
            box-shadow: -2px 0 5px rgba(0,0,0,0.3);
            overflow-y: auto;
            padding: 10px;
            visibility: visible;
            z-index: 1000;
        }
        #sidebar h3 { margin: 0 0 10px 0; }
        #sidebar ul { list-style: none; padding: 0; }
        #sidebar li { padding: 5px 0; cursor: pointer; }
        #sidebar li:hover { background: #f0f0f0; }
        #search {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            box-sizing: border-box;
        }
        .global-button {
            position: fixed;
            top: 20px;
            right: 10px;
            padding: 10px 20px;
            background: #0078A8;
            color: white;
            border: none;
            cursor: pointer;
            z-index: 1000;
        }
        .global-button:hover { background: #005f80; }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="sidebar">
        <input type="text" id="search" placeholder="Search by title or province...">
        <div id="asset-list"></div>
    </div>
    <button class="global-button" onclick="moveToProvince('Indonesia')">Indonesia</button>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map, markers = [];
        const assetData = [];

        // Load multiple asset files
        async function loadAssets() {
            const assetFiles = [
                'https://jang1117.github.io/palm/assets_riau.js',
                'https://jang1117.github.io/palm/assets_sumatera.js'
            ];
            try {
                const responses = await Promise.all(
                    assetFiles.map(file => fetch(file).then(res => res.ok ? res.text() : Promise.reject(`Failed to load ${file}`)))
                );
                responses.forEach((text, index) => {
                    const script = document.createElement('script');
                    script.text = text + `\nassetData.push(...assets);`;
                    document.body.appendChild(script);
                });
                console.log(`Loaded ${assetData.length} assets`);
                initializeMap();
                initializeSidebar();
            } catch (error) {
                handleAssetsLoadError(error);
            }
        }

        function handleAssetsLoadError(error) {
            console.error('Error loading asset files:', error);
            alert('Failed to load assets_riau.js or assets_sumatera.js. Please check the files and try again.');
        }

        function initializeMap() {
            map = L.map('map').setView([-2, 117], 7);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            const palmIcon = L.icon({
                iconUrl: 'https://jang1117.github.io/palm/palm_tree.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -32]
            });

            // Remove duplicates by title and sort
            const uniqueAssets = Array.from(new Map(assetData.map(item => [item.title, item])).values())
                .sort((a, b) => a.title.localeCompare(b.title));

            uniqueAssets.forEach(asset => {
                if (asset.position && asset.position.lat && asset.position.lng) {
                    const marker = L.marker([asset.position.lat, asset.position.lng], { icon: palmIcon })
                        .addTo(map)
                        .bindPopup(`
                            <b>${asset.title}</b><br>
                            Mill: ${asset.millCompanyName}<br>
                            Parent: ${asset.parentCompanyName}<br>
                            Address: ${asset.address}<br>
                            Province: ${asset.province}<br>
                            ${asset.description ? `Description: ${asset.description}` : ''}
                        `);
                    markers.push({ marker, asset });
                }
            });

            map.on('zoomend', updateMarkers);
            updateMarkers();
        }

        function updateMarkers() {
            const zoomLevel = map.getZoom();
            markers.forEach(({ marker, asset }) => {
                const isVisible = zoomLevel > 7 ? asset.province === 'Sumatera Barat' : true;
                if (isVisible) {
                    if (!map.hasLayer(marker)) marker.addTo(map);
                } else {
                    if (map.hasLayer(marker)) map.removeLayer(marker);
                }
            });
        }

        function moveToProvince(province) {
            const coords = {
                'Indonesia': [-2, 117, 5],
                'Sumatera Barat': [-0.95, 100.35, 8],
                'Sumatera Selatan': [-3.32, 103.97, 8],
                'Sumatera Utara': [2.12, 99.55, 8],
                'Riau': [0.5, 101.5, 8]
            }[province] || [-2, 117, 5];
            map.setView([coords[0], coords[1]], coords[2]);
        }

        function initializeSidebar() {
            const searchInput = document.getElementById('search');
            const assetList = document.getElementById('asset-list');

            // Group assets by province
            const groupedAssets = {};
            assetData.forEach(asset => {
                if (!groupedAssets[asset.province]) groupedAssets[asset.province] = [];
                groupedAssets[asset.province].push(asset);
            });

            // Sort provinces and assets
            const sortedProvinces = Object.keys(groupedAssets).sort();
            assetList.innerHTML = sortedProvinces.map(province => {
                const assets = groupedAssets[province].sort((a, b) => a.title.localeCompare(b.title));
                return `
                    <h3>${province}</h3>
                    <ul>${assets.map(asset => `<li onclick="map.setView([${asset.position.lat}, ${asset.position.lng}], 10)">${asset.title}</li>`).join('')}</ul>
                `;
            }).join('');

            // Search functionality
            searchInput.addEventListener('input', () => {
                const query = searchInput.value.toLowerCase();
                assetList.innerHTML = sortedProvinces.map(province => {
                    const assets = groupedAssets[province]
                        .filter(asset => asset.title.toLowerCase().includes(query) || asset.province.toLowerCase().includes(query))
                        .sort((a, b) => a.title.localeCompare(b.title));
                    return assets.length ? `<h3>${province}</h3><ul>${assets.map(asset => `<li onclick="map.setView([${asset.position.lat}, ${asset.position.lng}], 10)">${asset.title}</li>`).join('')}</ul>` : '';
                }).join('');
            });
        }

        // Start loading assets
        loadAssets();
    </script>
</body>
</html>
