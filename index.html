<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sumatra Mill Plant 지도</title>
    <style>
        /* 기본 스타일 */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        #map {
            height: 100vh;
            width: 100%;
        }
        /* 사이드바 스타일 */
        #sidebar {
            position: fixed;
            top: 150px;
            right: -300px;
            width: 300px;
            height: calc(100% - 150px);
            background: #f8f8f8;
            transition: right 0.3s ease;
            overflow-y: hidden;
            padding: 10px;
            box-shadow: -2px 0 5px rgba(0,0,0,0.2);
            z-index: 900;
        }
        #sidebar.open {
            right: 0;
        }
        #sidebar h2 {
            font-size: 1.5em;
            margin: 10px 0;
        }
        #sidebar .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            color: #000000;
            font-weight: bold;
            font-size: 16px;
        }
        #sidebar input {
            width: calc(100% - 20px);
            padding: 8px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        #sidebar ul {
            list-style: none;
            padding: 0;
        }
        #sidebar li {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #ddd;
        }
        #sidebar li:hover {
            background: #e0e0e0;
        }
        #sidebar details {
            margin-bottom: 10px;
        }
        #sidebar summary {
            font-weight: bold;
            padding: 8px;
            cursor: pointer;
            background: #e0e0e0;
            border-radius: 4px;
        }
        #toggleSidebar {
            position: fixed;
            top: 100px;
            right: 10px;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
            z-index: 1000;
        }
        #toggleSidebar:hover {
            background-color: #e0e0e0;
        }
        /* 팝업 창 스타일 */
        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
        }
        .popup-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            width: 360px;
            max-width: 90%;
            text-align: left;
        }
        .popup-content h3 {
            margin: 0 0 10px;
            font-size: 22px;
        }
        .popup-content p {
            margin: 0 0 15px;
            font-size: 16px;
            line-height: 1.4;
        }
        .popup-content .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            color: #000000;
            font-weight: bold;
            font-size: 16px;
        }
        .popup-content .move-button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .popup-content .move-button:hover {
            background-color: #0056b3;
        }
        /* Global 버튼 스타일 */
        .global-button {
            position: fixed;
            top: 60px;
            right: 10px;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
            z-index: 1000;
        }
        .global-button:hover {
            background-color: #e0e0e0;
        }
        /* 마커 라벨 스타일 */
        .gm-style .gm-label {
            font-size: 12px;
            color: #000000;
            background-color: #ffffff;
            padding: 3px 6px;
            border: 1px solid #999;
            border-radius: 2px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: bold;
        }
        /* 반응형 디자인 */
        @media (max-width: 600px) {
            #sidebar {
                width: 250px;
                right: -250px;
                height: calc(100% - 150px);
            }
            #sidebar.open {
                right: 0;
            }
            #toggleSidebar, .global-button {
                font-size: 12px;
                padding: 8px;
            }
            .popup-content {
                width: 300px;
            }
        }
    </style>
</head>
<body>
    <button id="toggleSidebar">자산 목록</button>
    <div id="sidebar">
        <span class="close-button" onclick="closeSidebar()">X</span>
        <h2>Palm Mill Plant</h2>
        <input type="text" id="searchInput" placeholder="자산 이름 검색...">
        <ul id="millList"></ul>
    </div>
    <div id="map"></div>
    <button class="global-button" onclick="resetMap()">Global</button>

    <!-- 팝업 창 -->
    <div class="popup-overlay" id="popupOverlay">
        <div class="popup-content" id="popupContent">
            <span class="close-button" onclick="closePopup()">X</span>
            <h3 id="popupTitle"></h3>
            <p id="popupDescription"></p>
            <div id="popupExtra"></div>
        </div>
    </div>

    <!-- assets.js 로드 -->
    <script src="https://jang1117.github.io/palm/assets.js" onerror="handleAssetsLoadError()"></script>
    <script>
        // 전역 변수 정의
        let map;
        let markers = [];

        // assets.js 로드 실패 시 처리
        function handleAssetsLoadError() {
            console.error("assets.js 로드 실패. 파일 경로 또는 구문을 확인하세요.");
            alert("자산 데이터를 로드하지 못했습니다. assets.js 파일을 확인하세요.");
        }

        // 마커 이미지 로드 디버깅
        const defaultIcon = 'https://jang1117.github.io/palm/palm_tree.png';
        const img = new Image();
        img.src = defaultIcon;
        img.onload = () => console.log("마커 이미지가 로드되었습니다: ", defaultIcon);
        img.onerror = () => console.error("마커 이미지 로드 실패: ", defaultIcon);

        // Google Maps API 로드 오류 디버깅
        window.addEventListener('error', (event) => {
            if (event.message.includes('google is not defined') || event.message.includes('maps')) {
                console.error('Google Maps API 로드 실패. API 키 또는 HTTP 리퍼러를 확인하세요.');
                alert('Google Maps API를 로드하지 못했습니다. 네트워크 또는 API 키를 확인하세요.');
            }
        });

        // 사이드바 닫기 함수
        function closeSidebar() {
            const sidebar = document.getElementById("sidebar");
            sidebar.classList.remove("open");
        }

        // 지도 초기화 함수
        window.initMap = function() {
            if (typeof window.google === 'undefined' || typeof window.google.maps === 'undefined') {
                console.error('Google Maps API가 로드되지 않았습니다. API 키와 네트워크를 확인하세요.');
                alert('Google Maps API 로드에 실패했습니다. API 키를 확인하세요.');
                return;
            }

            if (typeof assets === 'undefined') {
                console.error("assets.js가 로드되지 않았습니다. 파일을 확인하세요.");
                alert("자산 데이터를 로드하지 못했습니다. assets.js 파일을 확인하세요.");
                return;
            }

            // 지도 중심 설정 (인도네시아 서부 수마트라)
            map = new window.google.maps.Map(document.getElementById("map"), {
                zoom: 7,
                center: { lat: -1.5, lng: 101.0 },
                fullscreenControl: false,
                mapTypeId: window.google.maps.MapTypeId.ROADMAP
            });

            console.log(`지도 초기화 완료. 줌 레벨: ${map.getZoom()}`);

            // 줌 변경 이벤트 리스너
            map.addListener("zoom_changed", () => {
                console.log(`줌 레벨 변경: ${map.getZoom()}`);
                updateMarkers();
            });

            // 사이드바 초기 숨김
            document.getElementById("sidebar").classList.remove("open");

            // 초기 마커 업데이트
            updateMarkers();

            // 사이드바 목록 초기화
            initializeSidebar();
        };

        // 마커 업데이트 함수
        function updateMarkers() {
            // 기존 마커 제거
            markers.forEach(marker => marker.setMap(null));
            markers = [];

            const zoom = map.getZoom();

            if (zoom <= 7) {
                // 줌 레벨 7 이하: 전체 자산의 중심점에 단일 마커 표시
                let latSum = 0, lngSum = 0;
                assets.forEach(asset => {
                    latSum += asset.position.lat;
                    lngSum += asset.position.lng;
                });
                const center = {
                    lat: latSum / assets.length,
                    lng: lngSum / assets.length
                };

                const marker = new window.google.maps.Marker({
                    position: center,
                    map: map,
                    title: `인도네시아: ${assets.length}개 자산`,
                    icon: {
                        url: defaultIcon,
                        scaledSize: new window.google.maps.Size(40, 40),
                        labelOrigin: new window.google.maps.Point(20, 50)
                    },
                    label: {
                        text: `인도네시아 (${assets.length})`,
                        fontSize: "12px",
                        fontWeight: "bold",
                        color: "#000000",
                        fontFamily: "Arial, sans-serif"
                    }
                });

                marker.addListener("click", () => {
                    showPopup("인도네시아", `인도네시아: ${assets.length}개 자산`, 
                        `이 지역에는 ${assets.length}개의 팜 오일 자산이 있습니다.`, 
                        `<button class="move-button" onclick="moveToAssets()">자산 이동</button>`);
                });

                markers.push(marker);
            } else {
                // 줌 레벨 8 이상: 개별 자산 마커 표시
                assets.forEach(asset => {
                    const markerIcon = {
                        url: defaultIcon,
                        scaledSize: new window.google.maps.Size(40, 40),
                        labelOrigin: new window.google.maps.Point(20, 50)
                    };

                    const marker = new window.google.maps.Marker({
                        position: asset.position,
                        map: map,
                        title: asset.title,
                        icon: markerIcon,
                        label: {
                            text: asset.title,
                            fontSize: "12px",
                            fontWeight: "bold",
                            color: "#000000",
                            fontFamily: "Arial, sans-serif"
                        }
                    });

                    marker.addListener("click", () => {
                        const formattedDesc = asset.description 
                            ? `${asset.title}은 ${asset.millCompanyName} 소속의 팜 오일 생산 시설로, ${asset.parentCompanyName} 그룹의 일원입니다.<br>${asset.description.replace(/, /g, "<br>")}`
                            : `${asset.title}은 ${asset.millCompanyName} 소속의 팜 오일 생산 시설로, ${asset.parentCompanyName} 그룹의 일원입니다.`;
                        showPopup(asset.title, asset.title, formattedDesc, `
                            <p><strong>회사명:</strong> ${asset.millCompanyName}</p>
                            <p><strong>모회사:</strong> ${asset.parentCompanyName}</p>
                            <p><strong>주소:</strong> ${asset.address}</p>
                            <p><strong>지역:</strong> ${asset.province}</p>`);
                    });

                    markers.push(marker);
                });
            }
        }

        // 팝업 창 표시 함수
        function showPopup(id, title, description, extraContent) {
            const popupOverlay = document.getElementById("popupOverlay");
            const popupTitle = document.getElementById("popupTitle");
            const popupDescription = document.getElementById("popupDescription");
            const popupExtra = document.getElementById("popupExtra");

            popupTitle.textContent = title;
            popupDescription.innerHTML = description;
            popupExtra.innerHTML = extraContent;

            popupOverlay.style.display = "block";
        }

        // 팝업 창 닫기 함수
        function closePopup() {
            const popupOverlay = document.getElementById("popupOverlay");
            popupOverlay.style.display = "none";
        }

        // 전체 자산으로 이동
        function moveToAssets() {
            if (!map) {
                console.error("지도가 초기화되지 않았습니다.");
                return;
            }
            const bounds = new window.google.maps.LatLngBounds();
            assets.forEach(asset => {
                bounds.extend(new window.google.maps.LatLng(asset.position.lat, asset.position.lng));
            });
            map.fitBounds(bounds);

            const currentZoom = map.getZoom();
            if (currentZoom > 10) map.setZoom(10);
            if (currentZoom < 7) map.setZoom(7);
        }

        // 지도 초기화 (Global 뷰)
        function resetMap() {
            if (!map) {
                console.error("지도가 초기화되지 않았습니다.");
                return;
            }
            map.setZoom(7);
            map.setCenter({ lat: -1.5, lng: 101.0 });
            updateMarkers();
        }

        // 사이드바 초기화 및 검색 기능
        function initializeSidebar() {
            const millList = document.getElementById("millList");
            const searchInput = document.getElementById("searchInput");

            // 자산을 중복 제거 및 알파벳순 정렬
            function dedupeAndSortAssets(assets) {
                const uniqueAssets = [];
                const seenTitles = new Set();
                assets.forEach(asset => {
                    if (!seenTitles.has(asset.title)) {
                        seenTitles.add(asset.title);
                        uniqueAssets.push(asset);
                    }
                });
                return uniqueAssets.sort((a, b) => a.title.localeCompare(b.title));
            }

            // 자산을 지역별로 그룹화
            function groupAssetsByProvince(assets) {
                return assets.reduce((groups, asset) => {
                    const province = asset.province;
                    if (!groups[province]) {
                        groups[province] = [];
                    }
                    groups[province].push(asset);
                    return groups;
                }, {});
            }

            // 자산 목록 추가
            function populateMillList(filteredAssets = assets) {
                millList.innerHTML = "";
                const uniqueAssets = dedupeAndSortAssets(filteredAssets);
                const groupedAssets = groupAssetsByProvince(uniqueAssets);

                Object.keys(groupedAssets).sort().forEach(province => {
                    const details = document.createElement("details");
                    details.open = true; // 기본적으로 열려 있음
                    const summary = document.createElement("summary");
                    summary.textContent = `${province} (${groupedAssets[province].length})`;
                    details.appendChild(summary);

                    const ul = document.createElement("ul");
                    groupedAssets[province].sort((a, b) => a.title.localeCompare(b.title)).forEach(asset => {
                        const li = document.createElement("li");
                        li.textContent = asset.title;
                        li.addEventListener("click", () => {
                            map.setCenter(asset.position);
                            map.setZoom(15);
                            showPopup(asset.title, asset.title, 
                                asset.description 
                                    ? `${asset.title}은 ${asset.millCompanyName} 소속의 팜 오일 생산 시설로, ${asset.parentCompanyName} 그룹의 일원입니다.<br>${asset.description.replace(/, /g, "<br>")}`
                                    : `${asset.title}은 ${asset.millCompanyName} 소속의 팜 오일 생산 시설로, ${asset.parentCompanyName} 그룹의 일원입니다.`, 
                                `<p><strong>회사명:</strong> ${asset.millCompanyName}</p>
                                 <p><strong>모회사:</strong> ${asset.parentCompanyName}</p>
                                 <p><strong>주소:</strong> ${asset.address}</p>
                                 <p><strong>지역:</strong> ${asset.province}</p>`);
                        });
                        ul.appendChild(li);
                    });
                    details.appendChild(ul);
                    millList.appendChild(details);
                });
            }

            // 초기 목록 로드
            populateMillList();

            // 검색 기능
            searchInput.addEventListener("input", () => {
                const query = searchInput.value.toLowerCase();
                const filteredAssets = assets.filter(asset => 
                    asset.title.toLowerCase().includes(query) ||
                    asset.millCompanyName.toLowerCase().includes(query) ||
                    asset.parentCompanyName.toLowerCase().includes(query)
                );
                populateMillList(filteredAssets);
            });

            // 사이드바 토글
            document.getElementById("toggleSidebar").addEventListener("click", () => {
                const sidebar = document.getElementById("sidebar");
                sidebar.classList.toggle("open");
            });
        }

        // 페이지 로드 시 사이드바 숨김
        document.addEventListener("DOMContentLoaded", () => {
            document.getElementById("sidebar").classList.remove("open");
        });
    </script>

    <!-- Google Maps JavaScript API 로드 -->
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBKZ64N6aTmQLaU312nCqXeyrNa-lol2IQ&callback=initMap&loading=async"
        onerror="console.error('Google Maps API 스크립트 로드 실패. 네트워크 또는 API 키를 확인하세요.'); alert('Google Maps API 로드에 실패했습니다. API 키를 확인하세요.');">
    </script>
</body>
</html>
